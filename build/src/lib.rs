use std::env;
use std::fs;
use std::path::Path;
use std::process::Command;

use glob::glob;

pub fn build() {
    let out_dir = env::var("OUT_DIR").unwrap();
    let dest_path = Path::new(&out_dir).join("days.rs");
    let manifest_dir = env::var("CARGO_MANIFEST_DIR").unwrap();
    let manifest_dir = manifest_dir.replace("\\", "/"); // 兼容 Windows

    let mut days = Vec::new();

    println!("cargo:rerun-if-changed=src");

    for entry in glob("src/day*.rs").expect("Failed to read glob pattern") {
        match entry {
            Ok(path) => {
                let stem = path.file_stem().unwrap().to_str().unwrap().to_string();
                days.push(stem);
            }
            Err(e) => println!("cargo:warning=Glob error: {:?}", e),
        }
    }

    days.sort();

    let mut content = String::new();

    // 生成:
    // pub mod day01;
    // pub mod day02;
    // ...
    //
    // pub fn run_all_days() {
    //     day01::run();
    //     day02::run();
    //     ...
    // }

    content.push_str("// Auto-generated by build.rs\n\n");

    for day in &days {
        let path = format!("{}/src/{}.rs", manifest_dir, day);
        content.push_str(&format!(r#"#[path="{path}"] pub mod {day};"#));
    }

    content.push_str("\n\n");

    // B. 生成运行所有函数的入口
    content.push_str("pub fn run_all() {");

    for day in &days {
        content.push_str(&format!("println!(\"--- Running {day} ---\");"));
        content.push_str(&format!("{day}::run();"));
        content.push_str("println!();");
    }

    content.push_str("}");

    fs::write(&dest_path, content).unwrap();

    Command::new("rustfmt").arg(&dest_path).status().unwrap();
}
